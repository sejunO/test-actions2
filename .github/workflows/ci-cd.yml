name: Build & Deploy to ECS

on:
  push:
    branches:
      - main

jobs:

  # 변경된 모듈 감지
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      modules: ${{ steps.mods.outputs.modules }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed modules
        id: mods
        run: |
          changed_files=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
          changed_modules=$(echo "$changed_files" | cut -d/ -f1 | sort -u)
          modules=$(echo "$changed_modules" \
            | grep -E "^(discovery|gateway|user|project)$" \
            | jq -R -s -c 'split("\n") | map(select(length>0))')
          echo "modules=$modules" >> $GITHUB_OUTPUT

  # Docker Build & Push
  build-push:
    needs: detect-changes
    runs-on: ubuntu-latest
    if: ${{ needs.detect-changes.outputs.modules != '[]' }}

    strategy:
      matrix:
        module: ${{ fromJson(needs.detect-changes.outputs.modules) }}

    outputs:
      image: ${{ steps.build.outputs.image }}

    steps:
      - uses: actions/checkout@v4

      # AWS 인증
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      # ECR 로그인
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # Docker Build & Push
      - name: Build & Push Image
        id: build
        env:
          REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          MODULE="${{ matrix.module }}"
          ECR_REPO="$REGISTRY/nowayback/encore/$MODULE"
          TAG="${{ github.sha }}"

          docker build --platform linux/amd64 -t $ECR_REPO:$TAG -f $MODULE/Dockerfile .
          docker tag $ECR_REPO:$TAG $ECR_REPO:latest
          docker push $ECR_REPO:$TAG
          docker push $ECR_REPO:latest

          echo "image=$ECR_REPO:$TAG" >> $GITHUB_OUTPUT

  # ECS Deploy
  deploy:
    needs:
      - detect-changes
      - build-push
    runs-on: ubuntu-latest
    if: ${{ needs.detect-changes.outputs.modules != '[]' }}

    strategy:
      matrix:
        module: ${{ fromJson(needs.detect-changes.outputs.modules) }}

    steps:
      - uses: actions/checkout@v4

      # AWS 인증
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      # 현재 Task Definition 다운로드
      - name: Download current task definition
        run: |
          aws ecs describe-task-definition \
            --task-definition ${{ matrix.module }}-task \
            --query taskDefinition \
            --output json > task-definition.json

          jq 'del(
            .taskDefinitionArn,
            .revision,
            .status,
            .requiresAttributes,
            .placementConstraints,
            .compatibilities,
            .registeredBy,
            .registeredAt,
            .enableFaultInjection
          )' task-definition.json > task-def.json

      # Task Definition에 환경변수 직접 추가
      - name: Update task definition with environment variables
        run: |
          jq --arg image "${{ needs.build-push.outputs.image }}" \
             --arg db_url "${{ secrets.SPRING_DATASOURCE_URL }}" \
             --arg db_username "${{ secrets.SPRING_DATASOURCE_USERNAME }}" \
             --arg db_password "${{ secrets.SPRING_DATASOURCE_PASSWORD }}" \
          '.containerDefinitions[0].image = $image |
           .containerDefinitions[0].environment = [
             {
               "name": "SPRING_DATASOURCE_URL",
               "value": $db_url
             },
             {
               "name": "SPRING_DATASOURCE_USERNAME",
               "value": $db_username
             },
             {
               "name": "SPRING_DATASOURCE_PASSWORD",
               "value": $db_password
             },
             {
               "name": "SPRING_PROFILES_ACTIVE",
               "value": "prod"
             }
           ] |
           del(.containerDefinitions[0].secrets)' \
          task-def.json > updated-task-def.json

      # Task Definition 등록
      - name: Register new task definition
        id: register-task-def
        run: |
          TASK_DEF_ARN=$(aws ecs register-task-definition \
            --cli-input-json file://updated-task-def.json \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)
          echo "task-definition-arn=$TASK_DEF_ARN" >> $GITHUB_OUTPUT

      # ECS 배포
      - name: Deploy to ECS
        run: |
          aws ecs update-service \
            --cluster nowayback-encore-cluster \
            --service ${{ matrix.module }}-service \
            --task-definition ${{ steps.register-task-def.outputs.task-definition-arn }} \
            --force-new-deployment